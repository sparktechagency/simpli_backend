name: Deploy Node.js with TypeScript on DigitalOcean

on:
    push:
        branches:
            - "main"
    pull_request:
        branches:
            - "main"

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "20.10.0"

            - name: Install Dependencies
              run: npm install --frozen-lockfile

            - name: Install TypeScript Compiler
              run: npm install -g typescript

            - name: Build Project
              run: npm run build

    deploy:
        runs-on: ubuntu-latest
        needs: build

        steps:
            - uses: actions/checkout@v3

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "20.17"

            - name: Install Dependencies
              run: npm install --frozen-lockfile

            - name: Build Project
              run: npm run build

            # --- Configure SSH access to DigitalOcean droplet ---
            - name: Configure SSH
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.DO_SSH_PRIVATE_KEY }}
              run: |
                  mkdir -p ~/.ssh
                  echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts

            # --- Install PM2 on Droplet ---
            - name: Install PM2 on Droplet
              run: |
                  ssh ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} "sudo npm install -g pm2"

            # --- Deploy Backend (Node.js + TypeScript) ---
            - name: Deploy Backend to Droplet
              env:
                  DO_HOST: ${{ secrets.DO_HOST }}
                  DO_USER: ${{ secrets.DO_USER }}
                  ENV_VARS_JSON: ${{ secrets.ENV_VARS_JSON }}
              run: |
                  ssh $DO_USER@$DO_HOST "mkdir -p ~/applications/backend"
                  rsync -avz \
                    --exclude='.git' \
                    --exclude='node_modules' \
                    --exclude='.github' \
                    . $DO_USER@$DO_HOST:~/applications/backend/
                  ssh $DO_USER@$DO_HOST "cd ~/applications/backend && npm install --frozen-lockfile --production"
                  ssh $DO_USER@$DO_HOST "echo '$ENV_VARS_JSON' | jq -r 'to_entries | .[] | \"\(.key)=\(.value)\"' > ~/applications/backend/.env"
                  ssh $DO_USER@$DO_HOST "pm2 delete backend || true"
                  ssh $DO_USER@$DO_HOST "cd ~/applications/backend && pm2 start dist/server.js --name backend"
